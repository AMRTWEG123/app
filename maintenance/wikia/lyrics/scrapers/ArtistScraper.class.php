<?php
/**
 * Created by PhpStorm.
 * User: aquilax
 * Date: 2/25/14
 * Time: 4:37 PM
 */

class ArtistScraper extends BaseScraper {

	const INDEX_NAME = 'lyrics';
	const TYPE_NAME = 'artist';

	public function processArticle( Article $article ) {
		$artistData = [
			'index' => self::INDEX_NAME,
			'type' => self::TYPE_NAME,
			'article_id' => $article->getId(),
			'name' => $article->getTitle()->getText()
		];
		$artistData = array_merge( $artistData, $this->getHeader( $article ) );
		$artistData = array_merge( $artistData, $this->getFooter( $article ) );

		return $this->sanitizeData( $artistData, $this->getDataMap() );
	}

	protected function getHeader( Article $article ) {
		return $this->getTemplateValues( 'ArtistHeader', $article->getContent() );
	}

	protected function getFooter( Article $article ) {
		return $this->getTemplateValues( 'ArtistFooter', $article->getContent() );
	}

	function getAlbums( Article $article, $artistName) {
		$albums = [];
		$text = $article->getContent();
		$re_albums = '#==(.*?)==\s+(.*?)\{\{[c|C]lear\}\}#s';
		if ( preg_match_all( $re_albums, $text, $matches) ) {
			for ( $i = 0; $i < count($matches[0]); $i++ ) {
				$albumData = $this->getAlbumData( $matches[1][$i] );
				$albumData['pic'] = $this->getAlbumPic( $matches[2][$i], $artistName );
				$albums[] = $albumData;
			}
		}
		return $albums;
	}

	function getAlbumData( $heading ) {
		//==[[Entombed:Serpent Saints The Ten Amendments (2007)|Serpent Saints - The Ten Amendments (2007)]]==
		$result = [];
		$headinga = explode( '|', trim( $heading, '][=' ) );
		$result['title'] = $headinga[0];
		if ( preg_match('#(.+)\s\(([\d]+)\)#', $headinga[1], $matches) ) {
			$result['name'] = $matches[1];
			$result['year'] = $matches[2];
		} else {
			// TODO Better parser
			echo 'NEED BETTER Album title parser '.$heading.PHP_EOL;
		}
		return $result;
	}

	protected function getAlbumPic( $section, $artistName ) {
		$values = $this->getTemplateValues( 'Album Art', $section, '|', false );
		if ( !$values) {
			// No image
			return '';
		}
		if ( count( $values ) == 3 && $values[1] == '' ) {
			// Autogenerated image name
			// TODO: Check if this is correct
			return sprintf( '%s - %s.jpg', $artistName, $values[2] );
		}
		// Full File Name
		return $values[1];
	}

	public function getDataMap() {
		return [
			'article_id' => 'article_id',
			'name' => 'name',
			'romanizedArtist' => 'romanized_name',
			'pic' => 'image',
			'officialSite' => 'official_site',
			'myspace' => 'myspace',
			'twitter' => 'twitter',
			'facebook' => 'facebook',
			'wikia' => 'wikia',
			'wikipedia' => 'wikipedia',
			'wikipedia2' => 'wikipedia2',
			'country' => 'country',
			'state' => 'state',
			'hometown' => 'hometown',
			'iTunes' => 'itunes',
			'asin' => 'asin',
			'allmusic' => 'allmusic',
			'discogs' => 'discogs',
			'musicbrainz' => 'musicbrainz',
			'youtube' => 'youtube',
		];
	}

}
