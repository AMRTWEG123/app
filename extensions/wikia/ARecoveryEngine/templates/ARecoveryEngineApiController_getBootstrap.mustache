<!-- Begin recovery -->
<script type="text/javascript">
	require([
		"ext.wikia.adEngine.adContext"
	], function (adContext) {
		var context = adContext.getContext();

		if (context.opts.sourcePointRecovery === true) {
			{{{code}}}

			window._sp_ = window._sp_ || {};
			window._sp_.config = window._sp_.config || {};
			window._sp_.config.account_id = 106;
			window._sp_.config.publisher_base = '{{domain}}/{{cs_endpoint}}';
			window._sp_.config.enable_rid = true;

			window._sp_.bootstrap('{{domain}}/api/v1/ARecoveryEngine/delivery');

			window._sp_.config.content_control_callback = function () {
				var logGroup = 'ext.wikia.aRecoveryEngine.recovery.bootstrap';
				if (!window.wgUserName) {
					document.getElementById('WikiaArticle').style.display = 'none';
					document.getElementById('WikiaArticleMsg').style.display = 'block';
					window.addEventListener('load', function () {
						require(['ext.wikia.aRecoveryEngine.recovery.helper'], function (helper) {
							'use strict';
							helper.track('callback');
						});
					});
				} else {
					window.Wikia.log(['isContentControlEnabled', false], 'debug', logGroup);
				}
			};

			if (context.opts.sourcePointMMS === true) {
				window._sp_.mms = window._sp_.mms || {};
				window._sp_.mms.cmd = window._sp_.mms.cmd || [];

				window._sp_.mms.cmd.push(function () {
					window._sp_.mms.setTargeting("showmessage", "yes");
				});
				window._sp_.mms.cmd.push(function () {
					window._sp_.mms.startMsg();
				});

				window.addEventListener('load', function () {
					var mmsDomain = 'mms.bre.' + window.location.host.split('.').slice(-2).join('.');

					// THIS HAS TO BE SET AFTER MMSClient and Messaging libraries are loaded
					window._sp_.config.mms_domain = mmsDomain;
					window._sp_.config.mms_client_data_callback = function (mms) {
						// IF THERE IS NO MESSAGE DEFINED BUT USER MATCHES THE KEY-VAL - MSG_ID = 0
						// IF USER DOESN'T MATCH THE KEY-VAL - MSG_ID = 0
						// IF NOTHING CONFIGURED IN SP - CMPGN_ID = 0
						// IF USER NOT ASSIGNED TO BUCKET - PRTN_UUID = NULL
						if (mms.msgID === 0 || mms.cmpgn_id === 0 || mms.prtn_uuid === null) {
							require(['ext.wikia.adEngine.utils.eventDispatcher'], function (eventDispatcher) {
								eventDispatcher.dispatch('arecovery.mms.empty');
							});
						}
					};
				});

				window._sp_.bootstrap('{{domain}}/api/v1/ARecoveryEngine/SourcePointMessaging');
				window._sp_.bootstrap('{{domain}}/api/v1/ARecoveryEngine/SourcePointMMSClient');
			}

			window.addEventListener('load', function () {
				require(['ext.wikia.aRecoveryEngine.recovery.helper'], function (helper) {
					helper.verifyContent();
				});
			});
		}
	});

</script>
<!-- End recovery -->
